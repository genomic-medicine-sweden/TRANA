nextflow_pipeline {
    name "Test Main Pipeline"
    script "main.nf"

    test("Should run pipeline WITH porechop_abi ab_initio") {
        when {
            params {
                db = "$projectDir/assets/databases/emu_database"
                seqtype = "map-ont"
                longread_qc_qualityfilter_minlength = 1200
                longread_qc_qualityfilter_maxlength = 1800
                merge_fastq_pass = "$projectDir/assets/test_assets/ci"
                pipelines_testdata_base_path = "https://raw.githubusercontent.com/genomic-medicine-sweden/test-datasets/refs/heads/16s/"
                outdir = outputDir
                adapter_trimming        = true
                quality_filtering       = true
                save_preprocessed_reads = true
                ab_initio               = true
            }
        }
        then {
            assert workflow.success
            assert path("${params.outdir}/results/barcode01_filtered.fastq_rel-abundance.tsv").exists()
            assert path("${params.outdir}/results/barcode02_filtered.fastq_rel-abundance.tsv").exists()

            // Ensure that Porechop ABI has ran
            assert path("${params.outdir}/porechop_abi/barcode01.porechop_abi.log").exists()
            assert path("${params.outdir}/porechop_abi/barcode02.porechop_abi.log").exists()

            // Ensure that Filtlong has run and that processed reads were copied to the results
            assert path("${params.outdir}/filtlong/barcode01_filtered.log").exists()
            assert path("${params.outdir}/filtlong/barcode02_filtered.log").exists()
            assert path("${params.outdir}/filtlong/barcode02_filtered.fastq.gz").exists()
        }
    }
    test("Should run pipeline WITH custom_adapters (custom_adapters) and only_custom (discard_database) and adapter_cutoff (adapter_threshold)" ) {
        when {
            params {
                db = "$projectDir/assets/databases/emu_database"
                seqtype = "map-ont"
                longread_qc_qualityfilter_minlength = 1200
                longread_qc_qualityfilter_maxlength = 1800
                merge_fastq_pass = "$projectDir/assets/test_assets/ci"
                pipelines_testdata_base_path = "https://raw.githubusercontent.com/genomic-medicine-sweden/test-datasets/refs/heads/16s/"
                outdir = outputDir
                adapter_trimming  = true
                quality_filtering = true
                save_preprocessed_reads = true
                custom_adapters   = "$projectDir/assets/test_assets/custom_barcodes.txt"
                adapter_cutoff    = 90
                only_custom       = true
            }
        }
        then {
            assert workflow.success
            assert path("${params.outdir}/results/barcode01_filtered.fastq_rel-abundance.tsv").exists()
            assert path("${params.outdir}/results/barcode02_filtered.fastq_rel-abundance.tsv").exists()

            // Ensure that Porechop ABI has ran
            assert path("${params.outdir}/porechop_abi/barcode01.porechop_abi.log").exists()
            assert path("${params.outdir}/porechop_abi/barcode02.porechop_abi.log").exists()

            // Ensure that Filtlong has run and that processed reads were copied to the results
            assert path("${params.outdir}/filtlong/barcode01_filtered.log").exists()
            assert path("${params.outdir}/filtlong/barcode02_filtered.log").exists()
            assert path("${params.outdir}/filtlong/barcode02_filtered.fastq.gz").exists()
        }
    }

}
