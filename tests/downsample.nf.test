nextflow_pipeline {
    name "Test Main Pipeline"
    script "main.nf"

    test("Should run pipeline WITH the --sample_size parameter set") {
        when {
            params {
                db = "$projectDir/assets/databases/emu_database"
                seqtype = "map-ont"
                longread_qc_qualityfilter_minlength = 1200
                longread_qc_qualityfilter_maxlength = 1800
                merge_fastq_pass = "$projectDir/assets/test_assets/ci"
                pipelines_testdata_base_path = "https://raw.githubusercontent.com/genomic-medicine-sweden/test-datasets/refs/heads/16s/"
                outdir = outputDir

                // The parameters we are varying here
                sample_size = 100
                save_downsampled_reads = true
            }
        }
        then {
            assert workflow.success
            assert path("${params.outdir}/results/barcode01_downsampled.fastq_rel-abundance.tsv").exists()
            assert path("${params.outdir}/results/barcode02_downsampled.fastq_rel-abundance.tsv").exists()

            // Ensure that SeqTK Sample was run
            assert path("${params.outdir}/seqtk/barcode01_downsampled.fastq.gz").exists()
            assert path("${params.outdir}/seqtk/barcode02_downsampled.fastq.gz").exists()
        }
    }
}
